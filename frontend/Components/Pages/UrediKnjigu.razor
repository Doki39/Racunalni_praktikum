@page "/uredi/{Id:int}"
@rendermode InteractiveServer
@inject KnjigeApiService Api
@inject NavigationManager Nav

<PageTitle>Uredi knjigu</PageTitle>

<div class="container py-4">
    <a href="/upravljaj" class="btn btn-outline-secondary back-link">← Natrag na upravljanje</a>

    @if (loading) { <p>Učitavanje…</p> }
    else if (knjiga is null) { <p>Knjiga nije pronađena.</p> }
    else
    {
        <h2>Uredi knjigu</h2>

        <EditForm Model="model" OnValidSubmit="Spremi" FormName="urediKnjigu">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label">Naziv</label>
                <InputText class="form-control" @bind-Value="model.Naziv" />
            </div>
            <div class="mb-3">
                <label class="form-label">Autor</label>
                <InputText class="form-control" @bind-Value="model.Autor" />
            </div>
            <div class="mb-3">
                <label class="form-label">ISBN</label>
                <InputText class="form-control" @bind-Value="model.ISBN" />
            </div>
            <div class="mb-3">
                <label class="form-label">Knjižnice</label>
                @foreach (var k in knjiznice)
                {
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="elib_@k.Id"
                               checked="@izabraneKnjiznice.Contains(k.Id)"
                               @onchange="@(_ => ToggleKnjiznica(k.Id))" />
                        <label class="form-check-label" for="elib_@k.Id">@k.Naziv</label>
                    </div>
                }
            </div>
            <button type="submit" class="btn btn-primary" disabled="@sprema">Spremi</button>
            <a href="/upravljaj" class="btn btn-secondary ms-2">Odustani</a>
        </EditForm>

        @if (!string.IsNullOrEmpty(greska)) { <p class="text-danger mt-2">@greska</p> }
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    KnjigaDto? knjiga;
    List<KnjiznicaDto> knjiznice = new();
    HashSet<int> izabraneKnjiznice = new();
    UrediKnjiguModel model = new();
    string greska = "";
    bool loading = true, sprema;

    protected override async Task OnInitializedAsync()
    {
        knjiznice = await Api.GetKnjizniceAsync();
        knjiga = await Api.GetKnjigaAsync(Id);
        if (knjiga != null)
        {
            model.Naziv = knjiga.Naziv;
            model.Autor = knjiga.Autor;
            model.ISBN = knjiga.ISBN;
            izabraneKnjiznice = knjiga.KnjiznicaKnjige
                .Where(kk => kk.Knjiznica != null)
                .Select(kk => kk.Knjiznica!.Id)
                .ToHashSet();
        }
        loading = false;
    }

    void ToggleKnjiznica(int id)
    {
        if (izabraneKnjiznice.Contains(id)) izabraneKnjiznice.Remove(id);
        else izabraneKnjiznice.Add(id);
    }

    async Task Spremi()
    {
        sprema = true;
        greska = "";
        var (ok, err) = await Api.UrediKnjiguAsync(Id, model.Naziv, model.Autor, model.ISBN, izabraneKnjiznice.ToList());
        sprema = false;
        if (ok) Nav.NavigateTo("/upravljaj");
        else greska = err ?? "Greška pri spremanju.";
    }

    class UrediKnjiguModel
    {
        public string Naziv { get; set; } = "";
        public string Autor { get; set; } = "";
        public string ISBN { get; set; } = "";
    }
}
